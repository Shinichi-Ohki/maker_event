## 🔨 最重要ルール

### 作業開始時の必須手順
作業を開始する前に必ず以下を実行すること：
```bash
git pull
```
自動実行により頻繁にリモートが更新されるため、コンフリクトを防ぐために必須。

### 新しいルールの追加プロセス
ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

このプロセスにより、プロジェクトのルールを継続的に改善していきます。

## やりたいこと（完了済み）
- メイカー系イベントリストから、ウェブページ(静的)を生成スクリプトを作ってください
- リストはここにあります https://docs.google.com/spreadsheets/d/1a2XqNp01q6hFiyyFjq5hMlYGV66Z9UeOHZP4snSXaz0/edit?gid=0#gid=0
- このリストの中で、これから開催されるイベントを見やすく一覧にしたページを作るスクリプトを作ってほしいです
- 一覧ページは https://makerfaire.com/upcoming-faires/ を参考にしてください
- 海外のイベントは英語で表記してください
- 日本国内のイベントは日本語で表記してください
- スクリプトはPythonで書いてください
- Python仮想環境はuvで作成するので、必要なpyproject.toml を作成してください。
- スクリプトを実行する際はuv run [〜] を使ってください
- 英語と日本語でreadmeを作成してください。

## 追加機能の実装履歴

### 1. イベント画像の自動取得
- 各イベントのURLからOGP画像、Twitter Card画像、ファビコンを自動取得
- BeautifulSoupを使用してWebページをスクレイピング
- レート制限対応（0.5秒間隔）
- エラーハンドリング（アクセス制限やSSLエラーに対応）

### 2. OGP対応（SNSシェア機能）
- OGP（Open Graph Protocol）メタタグを追加
- Twitter Card対応
- SEO用メタタグ完備
- SNSでリンクシェア時に適切な画像・タイトル・説明文が表示

### 3. ガントチャート風OGP画像の生成
- 1200x630のOGP推奨サイズで画像生成
- タイムライン形式でイベントスケジュールを表示
- 日本のイベント（青系）と海外のイベント（ピンク系）で色分け
- 月区切り線と月表示
- イベント名、日付をドット形式で視覚化

### 4. 日本語フォント対応
- Noto Sans JP フォントの自動ダウンロード機能
- GitHub経由での確実なフォント取得
- フォールバック機能（システムフォント使用）
- 太字効果（重複描画による擬似ボールド）

### 5. OGP画像の改善
- 文字化けの修正（絵文字削除、統計情報行削除）
- 文字サイズの拡大（タイトル36px、イベント名20px、日付16px、統計18px）
- 太字効果の全面適用（タイトル、イベント名、日付、月表示）
- 絶対URLでのOGP画像参照（https://shinichi-ohki.github.io/maker_event/ogp_image.png）

### 6. フォントダウンロード機能の修正
- Google Fonts APIから動的にフォントURLを取得する方式に変更
- CSS解析でttfファイルURLを正規表現で抽出
- 複数のフォールバック方式を廃止し、APIベースの確実な方法に統一
- ダウンロードログの詳細化（URL、ファイルサイズ表示）

### 7. READMEの改善
- `uv sync`コマンドの削除（uvは自動的に依存関係を解決するため不要）
- 依存関係の自動管理についての説明を追加
- ライブデモURL（https://shinichi-ohki.github.io/maker_event/）をREADME先頭に追加

### 8. サムネイル取得の最適化
- 終了したイベントのサムネイル取得を停止
- `parse_events`関数からサムネイル取得処理を削除
- `filter_upcoming_events`関数にサムネイル取得処理を移動
- これから開催されるイベントのみサムネイル取得を実行（処理時間短縮、API負荷軽減）

### 9. 複数日開催イベントの日付表示改善
- Eventモデルに `date_from`, `date_to`, `parsed_date_from`, `parsed_date_to` フィールドを追加
- 開始日と終了日を個別に解析・管理
- `format_event_date`関数を追加して適切な日付フォーマットを実装
- 日付表示ロジック:
  - 単一日: `2025年08月16日` / `August 16, 2025`
  - 同月複数日: `2025年08月16日〜17日` / `August 16-17, 2025`
  - 月またぎ: `2025年08月31日〜09月01日` / `August 31 - September 1, 2025`
- Jinja2テンプレートで関数を使用できるよう設定

### 10. READMEのデプロイメント情報追加
- OGP画像URLのハードコーディングに関する注意事項を追加
- 異なるドメインにデプロイする際の設定変更箇所を明記
- フォントファイルとOGP画像URL設定の両方について注意事項をまとめて記載

### 11. テンプレートファイルの自動生成対応
- `templates/index.html`を自動生成ファイルとして明確化
- gitignoreに`templates/`ディレクトリを追加
- テンプレートファイルはスクリプト実行時に自動作成される仕組みに変更
- リポジトリの整理とクリーンアップを実施

### 12. OGP画像の複数日程対応改善
- OGP画像で複数日程イベントの日付表示を正しく処理
- 同月複数日: `08/02-03`（ゼロパディング対応）
- 月またぎ: `08/31-09/01`
- 複数日程イベントの視覚表現をカプセル型（丸角長方形）に変更
- 単一日イベントは正円、複数日イベントはカプセル型で視覚的に区別
- 中央の長方形と両端の半円を組み合わせた形状で実装
- カプセル型図形の上下バランス調整（長方形の底辺を1ピクセル調整）

### 13. マレーシア地域判定の修正
- 国判定ロジックにマレーシア/クアラルンプールのキーワードを追加
- `kuala lumpur`, `クアラルンプール`, `malaysia`, `マレーシア`をキーワードリストに追加
- クアラルンプールのイベントが日本扱いされていた問題を修正
- マレーシアのイベントが正しく海外イベントとして分類されるよう改善

### 14. 翌年イベント対応（年跨ぎ対応）
- 2025年のみから2025年+2026年のイベント表示に対応
- スプレッドシートの年ヘッダー行（「2025年」「2026年」）を正しく検出・解析
- 年の自動判定ロジックを実装（年ヘッダーに基づく正確な年設定）
- 日付フィルター期間を365日→730日（約2年）に拡張
- 既に年月日形式で記載されているデータと月日のみデータの混在に対応
- 年の重複問題（2026/2026/03/01形式）を修正
- 翌年の日程が決まっているイベントを適切に表示（例：2026年のキーボードマーケット等）

### 15. 開催中イベントの表示改善
- 今日開催中のイベントが表示されない問題を修正
- フィルタリング条件を「現在時刻以降」から「今日の0時以降」に変更
- 7/19開催の「DIYデジタルガジェット」「PicoRuby Overflow会議」が正しく表示されるよう対応
- `filter_upcoming_events`関数の条件を `event.parsed_date >= now` → `event.parsed_date >= today_start` に修正

### 16. 複数日開催イベントのフィルタリング改善
- 複数日開催イベント（7/18-20等）が表示されない問題を修正
- 終了日も考慮したフィルタリングロジックに変更
- Open Sauce 2025（7/18-20、サンフランシスコ）とmake.ctrl.Japan（7/18-20、京都）が正しく表示されるよう対応
- イベントが今日以降に終了する、または今後開始するイベントを含めるロジックに改善
- `event_end_date >= today_start and event_start_date <= cutoff_date` の条件で包括的にフィルタリング

### 17. 画像取得の並列処理化
- `ThreadPoolExecutor`を使用した並列画像取得機能を実装
- 最大5つのワーカーで同時に画像を取得（処理時間の大幅短縮）
- `fetch_event_image`関数を新設して単一イベントの画像取得を分離
- 0.1秒間隔でのタスク開始により、サーバーへの負荷を分散
- `as_completed`を使用して完了順にタスクを処理
- エラーハンドリングを改善（個別の画像取得失敗が全体に影響しない）
- BeautifulSoupの型安全性向上（`Tag`型チェック追加）
- 従来の順次処理（0.5秒×イベント数）から並列処理への効率化

### 18. スプレッドシート変更検出機能
- Google Sheetsの内容変更を効率的に検出する機能を実装
- MD5ハッシュ値による変更検出（HTTPヘッダーが利用不可のため）
- `.last_state.json`ファイルによる前回状態の永続化
- 変更がない場合は処理を早期終了してリソースを節約
- 定期実行の効率化を目的とした最適化
- 状態ファイルには`content_hash`、`last_updated`、`event_count`を記録
- エラー時は安全側に倒して更新を実行する設計
- 初回実行時は変更として検出し、以降は実際の変更のみHTML生成
- `has_spreadsheet_changed()`、`load_last_state()`、`save_last_state()`関数を新設

### 19. 定期実行とGit自動プッシュ機能
- GitHub Actions による毎日定時の自動実行機能を実装
- スクリプトに`--auto-push`オプションを追加してGit自動コミット・プッシュに対応
- `--force`オプションで変更検出をスキップして強制実行が可能
- 自動コミットメッセージにタイムスタンプとClaude Code署名を含める
- GitHub Actions ワークフロー（`.github/workflows/update-events.yml`）を作成
- 毎日午前3時（JST）に自動実行、手動実行も可能
- 変更がない場合はコミットをスキップして効率化
- `auto_commit_and_push()`関数でGit操作を自動化
- サーバーレスでメンテナンスフリーな定期更新システム

### 20. システム統合とドキュメント最終更新
- GitHub Actions実行時刻を午前3時（JST）に調整（ユーザー要望対応）
- CLAUDE.mdのセキュリティチェック実施（ローカルパス等の機密情報なし確認）
- README.mdの全面更新で最新機能を網羅的に記載
- 新機能6項目（変更検出、自動プッシュ、定期実行等）をFeaturesセクションに追加
- Usageセクションに4つのコマンドライン実行例を詳細記載
- Project Structureに`.github/workflows/`と`.last_state.json`を追加
- 完全自動化システムの稼働準備完了
- 全体システムの動作検証とテスト実行を完了
- 効率的な定期実行（変更なし時1-2秒、通常時10-20秒）を実現

### 21. GitHub Actions ワークフロー修正
- 自動実行が失敗した原因を調査・特定
- YAML構文エラー（line 59）を修正：マルチライン文字列の適切なインデント処理
- 依存関係の問題を解決：`uv.lock`ファイルをリポジトリに追加
- `.gitignore`を修正して`uv.lock`を追跡対象に変更
- ワークフローで`uv sync --frozen`を使用して再現可能なビルドを実現
- Python プロジェクト用の包括的な`.gitignore`設定を追加
- GitHub Actions の自動実行機能を完全に修復

### 22. ページ更新日時表示機能
- ページ下部に更新日時を表示するフッター機能を実装
- 日本時間（JST）での更新日時表示：`YYYY-MM-DD HH:MM JST`形式
- 控えめなデザイン（グレー文字、小さいフォント、上部ボーダー線）
- テンプレートエンジンに`last_updated`変数を追加
- 手動実行・自動実行問わず常に最新の実行時刻を記録
- ユーザーがページの更新タイミングを容易に確認可能

### 23. OGP画像のページ内表示機能
- せっかく生成したガントチャート風OGP画像をページ内でも活用
- 更新日時の直上（ページ最下部）に「イベントスケジュール | Event Timeline」として表示
- レスポンシブデザイン対応（max-width: 100%）
- 角丸（border-radius: 8px）と影効果（box-shadow）でデザイン性を向上
- 上部の詳細イベントリストと下部のタイムライン画像で情報の二重提供
- ユーザーがイベント全体のスケジュールを視覚的に把握可能

## 技術スタック
- **言語**: Python 3.8+
- **パッケージ管理**: uv
- **主要ライブラリ**: 
  - requests (HTTP通信)
  - beautifulsoup4 (HTMLパース)
  - jinja2 (テンプレートエンジン)
  - pillow (画像生成)
  - python-dateutil (日付解析)
  - pydantic (データバリデーション)
  - fonttools (フォント処理)

## 生成されるファイル
- `index.html` - メイン静的サイト（OGPタグ付き）
- `ogp_image.png` - ガントチャート風OGP画像
- `NotoSansJP-Regular.ttf` - 日本語フォント（自動ダウンロード）
- `templates/index.html` - Jinja2テンプレート（自動生成）
- `.last_state.json` - 前回の実行状態（変更検出用）

## 実行方法

### 基本実行
```bash
uv run generate_events.py
```

### オプション付き実行
```bash
# 自動Git プッシュ付きで実行
uv run generate_events.py --auto-push

# 変更検出をスキップして強制実行
uv run generate_events.py --force

# 強制実行 + 自動プッシュ
uv run generate_events.py --force --auto-push
```

### 定期実行（自動）
- GitHub Actions により毎日午前3時（JST）に自動実行
- 手動実行も GitHub の Actions タブから可能
- 変更がない場合は自動的にスキップ

## 特記事項
- Google Sheetsのデータを直接CSVとして取得
- 今後開催されるイベントのみを自動フィルタリング
- レスポンシブデザイン対応
- 文字化け対策済み
- フォントファイルはライセンスの関係でリポジトリに含めず、自動ダウンロード
- スプレッドシート変更検出により効率的な定期実行が可能
- 変更がない場合は約1-2秒で処理完了（通常は10-20秒）